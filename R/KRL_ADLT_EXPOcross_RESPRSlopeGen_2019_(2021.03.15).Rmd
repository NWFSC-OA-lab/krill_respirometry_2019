
---
title: "Respirometry Trials for Summer Krill 2019"
output:
 html_document:
    df_print: paged
    code_folding: hide
    toc: TRUE
    toc_depth: 4
    toc_float: true
    theme: cerulean
    highlight: haddock
    smart: false
editor_options: 
  chunk_output_type: inline
---


Hello World

Author: OA Lab, NWFSC
Title: Respirometry Trials for Summer Krill 2019 Slope Generation
KRL_ADLT_EXPOcross_RESPRsmr2019(2021.03.15)
Krill, Adult, Exposure Cross Respirometry Summer 2019 (date modified)
Date: December 2020 - March 2021


# Version Check
```{r 0.1 Version Check , echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#*********************************
## Version Check
#********************************* 
R.version

```



# Libraries
```{r 0.0 Libraries , echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#*********************************
##Libraries
#********************************* 
library(stringr)
library(tidyverse)
library(plyr)
library(nlme)
library(tidyr)
library(dbplyr)
library(dplyr)
library(purrr)
library(wql)
library(lubridate)
library(tibbletime)
library(arsenal)
library(compareDF)
library(todor)
#for graphing
library(ggplot2)
library(ggfortify)
library(stringr)
library(nlme)
library(RColorBrewer)
library(patchwork)
#statistical analysis
library(gdata)
library(rsq)
library(doBy)
library(lme4)
library(lmerTest)
#Rnotebooks 
library(gridExtra)
library(kableExtra)
library(todor)
#metadata
library(metacsv)

```


 
# 1.) Setting Working Directory
```{r 1.) Setting Working Directory }
#*********************************
## 1.) Setting Working Directory
#*********************************

#set working directory to the correct folder
# just kidding let's us the here package

# setwd("/Users/paul.mcelhany/Downloads")
setwd("/Users/katherinerovinski/GIT/NWFSC.MUK_KRL2019respirometry90min")


```





# 2.) Dataframe 
```{r}

#*********************************
## 2.) Creating the initial Dataframe, dRESP
#*********************************

dResp90 <- read.csv(file = "KRL_ADLT_EXPOcross_RespirometryDataframe_Summer2019_(2021.03.15).csv", stringsAsFactors = FALSE)
dim(dResp90)
# dRESP <- read_csv(here("01_rawData", "KRL_ADLT_EXPOcross_RespirometryDataframe_Summer2019_(2021.03.15).csv"))

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

```


# 3.) Investigating Outliers 
The following chunks are broken apart to display how the Sparkle function was written.

### 3.e Example of loop and function writting Kate is trying to for each krill
### 3.1e) take 1 df at a time 
```{r 3.1e take the first dataframe}

# read the 1 dataframe per trial
# observe it learn it's secrets
dim(dResp90)

```


### 3.2f) Use the unique tool to get names for each krill
```{r 3.2f) Use the unique tool to get names for each krill}

unique(dResp90$KrillID)
unique_dResp90 <- unique(dResp90$KrillID)
kable(unique_dResp90)

```



### 3.2g) Create a linear model object for 1 krill 
```{r 3.2g) Create a linear model object for 1 krill}

df_KrillR11 <- dResp90[dResp90$KrillID == "Trial01_KrilLR11",]
lm_KrillR11 <- lm(df_KrillR11$oxygen ~ df_KrillR11$delta_t)

```



### 3.2h) Use the fortify function to get the residuals and cook.sd for each observation
```{r 3.2h) Use the fortify function to get the residuals and cook.sd for each observation}

#lm_KrillR11 <- lm(df_KrillR11$oxygen ~ df_KrillR11$delta_t)
#lm_KrillR11 is the referenced linear model object
df.lm.KrillR11 <- fortify(lm_KrillR11, df_KrillR11)
#kable(df.lm.KrillR11)

```



### 3.2i) Indentify which observations have a cooksd score above 4/n
n is the whole number of observations on that krill in the vial
```{r 3.2i) Indentify which observations have a cooksd score above 4/n}

# df.lm.KrillR11sat$.cooksd <- df.lm.KrillR11[df.lm.KrillR11$.cooksd <= 4/(length(df.lm.KrillR11$KrillID)), ]

```



### 3.2j) Use one dataframe to sort another
```{r 3.2j) Use one dataframe to sort another}

df.lm.KrillR11$.cooksd <= 4/(length(df.lm.KrillR11$KrillID))


```


# 4.) Krill Sparkle Function (standard krillslopes dataframe)
```{r 14.) Krill Sparkle Function}

KRILLLmSparkle <- function(dfToFilter) {
  # Determine the unique list of Krill IDs
  krillIds <- unique(dfToFilter$KrillID)
  
  # Create an empty list to hold the filtered dataframes we'll eventually combine
  filteredData <- list()
  filteredDataIndex <- 1
  
  # Loop over each Krill ID
  for (krillId in krillIds) {
    #print(krillId)
    # Split the dataframe by the Krill ID
    filteredKrillIdData <- dfToFilter[dfToFilter$KrillID == krillId,]
    #print(filteredKrillIdData)
    
    # Create the Linear Model of the resulting sub data frame
    lm_Krill <- lm(filteredKrillIdData$oxygen ~ filteredKrillIdData$delta_t)
    
    # Calculate the residuals and cook stdev scores and layer them on as columns into the filtered dataframe
    df.lm.Krill <- fortify(lm_Krill, filteredKrillIdData) 
    #print(df.lm.Krill)
    
    # Filter out measurements that are outliers based on the cook stdev value
    df.lm.Krill <- df.lm.Krill[df.lm.Krill$.cooksd <= 4/(length(df.lm.Krill$KrillID)), ]
    #print(df.lm.Krill)
    
    # Merge the filtered data back into the dataframe to return
    filteredData[[filteredDataIndex]] <- df.lm.Krill
    filteredDataIndex <- filteredDataIndex + 1
  }
  
  # Combine the list of dataframes into a single dataframe and return it
  return(do.call(rbind, filteredData))
}

# stop here and go to next unique krill ID

dResp90.filtered <- KRILLLmSparkle(dResp90)


```



# 8.) Analysis, Respirometry - Creating the Slope Function 
```{r 8.) Analysis, Respirometry - Creating the Slope Function}
#*********************************
## 8.) Analysis, Respirometry - Creating the Slope Function  
#*********************************  

#slope function of 2 vectors
slope <- function(y,x){
  return(lm(y~x, na.action = na.omit)$coefficients[2])
}
  
#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

cSlopes <- by(dResp90.filtered , dResp90.filtered$KrillID, function(x){ slope(x$oxygen, x$delta_t)})


#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

#creating a data frame instead of a list 
ds <- as.data.frame(sapply(cSlopes, I))
#having row names be a variable in a column to be able to pull it out for later merging 
ds$TrialID<- row.names(ds)





```



# 9.) Merging ds and dRESPmsr (create dtotal)
```{r 9.) Merging ds and dRESPmsr}
#add column to dslopes that's KrillID
#View(dref)
ds$KrillID <- row.names(ds)
#View(dslopes)
dtotal <- merge(dRESPmsr90, ds, by = "KrillID")
#View(dtotal)

```



# 10.) Krill ID as a factor & Grouping by Krill ID
```{r 10.) Krill ID as a factor & Grouping by Krill ID}
dtotal$KrillID <- factor(dtotal$KrillID)
nlevels(dtotal$KrillID)


```
60 is the number of vials when Ambient Treatment is excluded


# 11.) Analysis, Respirometry - Creating Slope Functions & Linear Models  
```{r 11.) Analysis, Respirometry - Creating Slope Functions & Linear Models  }
#*********************************
## 11.1) Creating the ds dataframe
#*********************************
# #get slopes and r^2 values from dtotal 

dSlopes <- data.frame(KrillID = levels(dtotal$KrillID))
# dSlopes$slope <- NA
# dSlopes$rsq <- NA

for(i in 1:length(dSlopes$KrillID)){
   m <- lm(oxygen ~ delta_t,
                         dtotal[dtotal$KrillID == dSlopes$KrillID[i],],
                         na.action=na.omit)
  dSlopes$slope[i] <- m$coefficients[2]
  dSlopes$rsq[i] <- summary(m)$r.squared
}

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

krillslopes <- merge(dtotal, dSlopes, by="KrillID")

dSlopes$SensorName <- ""

dSlopes <- dSlopes %>% group_by(KrillID)
dRESPanimal <- dRESPanimal %>% group_by(SensorName)

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

# TODO filter dRESPanimal against Ambient
# 
# 
# dSlopes$KrillID <- as.character(dSlopes$KrillID)
# dSlopes$SensorName <- dRESPanimal$SensorName
# dSlopes$TrialID <- dRESPanimal$TrialID
# dSlopes$MOATS <- dRESPanimal$MOATS
# dSlopes$Treatment<- dRESPanimal$Treatment
# dSlopes$LoadingLocation<- dRESPanimal$LoadingLocation
# dSlopes$VialNum<- dRESPanimal$GlassVialNumber
# dSlopes$TelsonLength<- dRESPanimal$TelsonLength..mm.
# dSlopes$WetWeight<- dRESPanimal$Size

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

```


# 19.) Krill ID as a factor & Grouping by Krill ID - filtered DFs
```{r 19.)  Krill ID as a factor & Grouping by Krill ID - filtered DFs}
# dtotal$KrillID <- factor(dtotal$KrillID)
# nlevels(dtotal$KrillID)


```
60 is the number of vials when Ambient Treatment is excluded


# 20.) Analysis, Respirometry - Creating Slope Functions & Linear Models  
```{r 20.) Analysis, Respirometry - Creating Slope Functions & Linear Models  }
#*********************************
## 11.1) Creating the ds dataframe
#*********************************
# #get slopes and r^2 values 
#dtotal
#ksT1to4
#ks80
#ks70
#ks1hr


# ksT1to4total 
# ks80total 
# ks70total 
# ks1hrtotal 

###  dSlopes (Old Example)
# 
# dSlopes <- data.frame(KrillID = levels(dtotal$KrillID))
# # dSlopes$slope <- NA
# # dSlopes$rsq <- NA
# 
# for(i in 1:length(dSlopes$KrillID)){
#    m <- lm(oxygen ~ delta_t,
#                          dtotal[dtotal$KrillID == dSlopes$KrillID[i],],
#                          na.action=na.omit)
#   dSlopes$slope[i] <- m$coefficients[2]
#   dSlopes$rsq[i] <- summary(m)$r.squared
# }


# Using " kSlopes.filtered " to only use outlier filtered dataframe.  

df_kSlopes <- data.frame(KrillID = levels(kSlopes.filtered$KrillID))
# dSlopes$slope <- NA
# dSlopes$rsq <- NA

for(i in 1:length(df_kSlopes$KrillID)){
   m <- lm(oxygen ~ delta_t,
                         kSlopes.filtered[kSlopes.filtered$KrillID == df_kSlopes$KrillID[i],],
                         na.action=na.omit)
  df_kSlopes$slope[i] <- m$coefficients[2]
  df_kSlopes$rsq[i] <- summary(m)$r.squared
}


df_kSlopes$SensorName <- ""

df_kSlopes <- df_kSlopes %>% group_by(KrillID)
dRESPanimal <- dRESPanimal %>% group_by(SensorName)

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

df_kSlopes$KrillID <- as.character(df_kSlopes$KrillID)
df_kSlopes$SensorName <- dRESPanimal$SensorName
df_kSlopes$TrialID <- dRESPanimal$TrialID
df_kSlopes$MOATS <- dRESPanimal$MOATS
df_kSlopes$Treatment<- dRESPanimal$Treatment
df_kSlopes$LoadingLocation<- dRESPanimal$LoadingLocation
df_kSlopes$VialNum<- dRESPanimal$GlassVialNumber
df_kSlopes$TelsonLength<- dRESPanimal$TelsonLength..mm.
df_kSlopes$WetWeight<- dRESPanimal$Size


# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

```



# 21.) Analysis, Respirometry - Correcting the Slope for Blanks
```{r 21.) Analysis, Respirometry - Correcting the Slope for Blanks}

#*********************************
## 21.) Analysis, Respirometry - Correcting the Slope for Blanks 
#*********************************

#blank corrected slope and blank-size corrected slope
## need to correct all slopes with the blanks' slope
## this is the background respiration of whatever phtyos and instrument drift
## create a mean blank slope per trial
## merge with the master(krill slopes) and "correct" all slopes against mean value (per trial)
# x is equal to the blank vials  

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

# Creating four separate means from the blank vials per trial
x <- subset(kSlopes.filtered, MOATS == "blank")
# x <- droplevels(filter(x, Treatment != "AMB"))
# x <- droplevels(filter(x, Treatment != "CUR"))
# x <- droplevels(filter(x, Treatment != "CHG"))


xtrial1 <- subset(x, x$TrialID.x == "Trial01")
xtrial2 <- subset(x, x$TrialID.x == "Trial02")
xtrial3 <- subset(x, x$TrialID.x == "Trial03")
xtrial4 <- subset(x, x$TrialID.x == "Trial04")

blankmeanslope1 <- mean(xtrial1$slope)
blankmeanslope2 <- mean(xtrial2$slope)
blankmeanslope3 <- mean(xtrial3$slope)
blankmeanslope4 <- mean(xtrial4$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

#Creating new corrected variables for slopes adjusted for blank vials and size of animal
df_kSlopes$CorrSlope <- ""
df_kSlopes$CorrSlope <- as.numeric(df_kSlopes$CorrSlope)
df_kSlopes$slope <- as.numeric(df_kSlopes$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Conditional Statement directing certain means to their respective trials
# take absolute values not to add a negative nubmer

df_kSlopes <- df_kSlopes %>% mutate(CorrSlope=case_when(
    (df_kSlopes$MOATS == "blank" ~ df_kSlopes$slope),
    (df_kSlopes$TrialID == "Trial01" ~ df_kSlopes$slope-((blankmeanslope1))),
    (df_kSlopes$TrialID == "Trial02" ~ df_kSlopes$slope-((blankmeanslope2))),
    (df_kSlopes$TrialID == "Trial03" ~ df_kSlopes$slope-((blankmeanslope3))),
    (df_kSlopes$TrialID == "Trial04" ~ df_kSlopes$slope-((blankmeanslope4))),
    TRUE ~ as.numeric(0)
))


# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Correcting for the size of the animal 
df_kSlopes$WetWeight <- as.numeric(df_kSlopes$WetWeight)
df_kSlopes$CorrWeightSlope <- df_kSlopes$CorrSlope/df_kSlopes$WetWeight

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |


#create plots and perhaps convert to larger units

``` 




# 21. Summary Statisitics on the Unfiltered Dataframe dSlopes
```{r 21. Summary Statisitics on the Unfiltered Dataframe dSlopes}

factor(df_kSlopes$TrialID)

df_kSlopes <- filter(df_kSlopes, Treatment != "AMB")  
df_kSlopes<- droplevels(filter(df_kSlopes, Treatment != "AMB"))
df_kSlopes<- droplevels(filter(df_kSlopes, Treatment != "n/a"))

df_kSlopes.summary <- df_kSlopes %>% group_by(Treatment) %>%
  dplyr::summarize(sd = sd(CorrWeightSlope, na.rm = TRUE), 
            mean = mean(CorrWeightSlope, na.rm = TRUE), 
            median = median(CorrWeightSlope, na.rm = TRUE),
            IQR = IQR(CorrWeightSlope, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  mutate(ci = se*1.96)
df_kSlopes.summary

kable(df_kSlopes.summary, digits = 4)

write.csv(df_kSlopes.summary, "2021.03.08_df_kSlopes_summary.csv")
```


## 21.a) Summary Statistics Graphed with Standard dSlope Values  
```{r 21.a Summary Statistics Graphed with Standard dSlope Values, warning=FALSE}

ggplot(df_kSlopes, aes(Treatment, CorrWeightSlope)) +
            # geom_jitter(color = "grey") +
            geom_jitter(data = df_kSlopes, aes(Treatment, CorrWeightSlope)) +
            geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
            geom_point(data = df_kSlopes.summary, 
                              aes(x=Treatment, y=mean), 
                              size=5, color = "purple") + 
            geom_errorbar(data = df_kSlopes.summary, 
                          aes(x=Treatment, y=mean, 
                              ymin = mean-sd, 
                              ymax = mean+sd), 
                              color = "blue") +
            geom_errorbar(data = df_kSlopes.summary,
                          aes(x=Treatment, 
                              y=mean, 
                              ymin = mean-ci, 
                              ymax = mean+ci),
                              colour = "red") +
            # facet_wrap(~TrialID) +
            ggtitle("Standard Krill Slope (outliers filtered & corrected for animal weight)  Values grouped by Treatment") +
            theme_bw() 


```


```{r}
kable(dSlopes.summary, digits = 4)

```




# 21.b) Analysis, Respirometry - Correcting the Slope for Blanks - 80% cutoff
```{r 21.b) Analysis, Respirometry - Correcting the Slope for Blanks  - 80% cutoff}

#*********************************
## 21.b) Analysis, Respirometry - Correcting the Slope for Blanks  - 80% cutoff
#*********************************

#blank corrected slope and blank-size corrected slope
## need to correct all slopes with the blanks' slope
## this is the background respiration of whatever phtyos and instrument drift
## create a mean blank slope per trial
## merge with the master(krill slopes) and "correct" all slopes against mean value (per trial)
# x is equal to the blank vials  

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

# Creating four separate means from the blank vials per trial
x80 <- subset(ksSlopes80, ksSlopes80$MOATS == "blank")
df_kSlopes<- droplevels(filter(df_kSlopes, Treatment != "AMB"))

x80trial1 <- subset(x80, x80$TrialID == "Trial01")
x80trial2 <- subset(x80, x80$TrialID == "Trial02")
x80trial3 <- subset(x80, x80$TrialID == "Trial03")
x80trial4 <- subset(x80, x80$TrialID == "Trial04")

blank80meanslope1 <- mean(x80trial1$slope)
blank80meanslope2 <- mean(x80trial2$slope)
blank80meanslope3 <- mean(x80trial3$slope)
blank80meanslope4 <- mean(x80trial4$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

#Creating new corrected variables for slopes adjusted for blank vials and size of animal
ksSlopes80$CorrSlope <- ""
ksSlopes80$CorrSlope <- as.numeric(ksSlopes80$CorrSlope)
ksSlopes80$slope <- as.numeric(ksSlopes80$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Conditional Statement directing certain means to their respective trials
# take absolute values not to add a negative nubmer

ksSlopes.80 <- ksSlopes80 %>% mutate(CorrSlope=case_when(
    (ksSlopes80$MOATS == "blank" ~ ksSlopes80$slope),
    (ksSlopes80$TrialID == "Trial01" ~ ksSlopes80$slope-((blank80meanslope1))),
    (ksSlopes80$TrialID == "Trial02" ~ ksSlopes80$slope-((blank80meanslope2))),
    (ksSlopes80$TrialID == "Trial03" ~ ksSlopes80$slope-((blank80meanslope3))),
    (ksSlopes80$TrialID == "Trial04" ~ ksSlopes80$slope-((blank80meanslope4))),
    TRUE ~ as.numeric(0)
))

ksSlopes80 <- ksSlopes.80


# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Correcting for the size of the animal 
ksSlopes80$WetWeight <- as.numeric(ksSlopes80$WetWeight)
ksSlopes80$WetWeightSlope <- ksSlopes80$CorrSlope/ksSlopes80$WetWeight

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |


#create plots and perhaps convert to larger units

``` 




# 21.c) Summary Statisitics on the Unfiltered Dataframe dSlopes
```{r 21.c) Summary Statisitics on the Unfiltered Dataframe dSlopes}

# factor(dSlopes$TrialID)
# 
# dSlopes <- filter(dSlopes, Treatment != "AMB")  
ksSlopes80<- droplevels(filter(ksSlopes80, Treatment != "n/a"))

ksSlopes80.summary <- ksSlopes80 %>% group_by(Treatment) %>%
  dplyr::summarize(sd = sd(CorrSlope, na.rm = TRUE), 
            mean = mean(CorrSlope, na.rm = TRUE), 
            median = median(CorrSlope, na.rm = TRUE),
            IQR = IQR(CorrSlope, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  mutate(ci = se*1.96)
ksSlopes80.summary

kable(ksSlopes80.summary, digits = 4)

write.csv(ksSlopes80.summary, "2021.01.26_ksSlopes80_summary.csv")
```


# 21.d) Analysis, Respirometry - Correcting the Slope for Blanks - 70% cutoff
```{r 21.d) Analysis, Respirometry - Correcting the Slope for Blanks  - 70% cutoff}

#*********************************
## 21.d) Analysis, Respirometry - Correcting the Slope for Blanks  - 80% cutoff
#*********************************

#blank corrected slope and blank-size corrected slope
## need to correct all slopes with the blanks' slope
## this is the background respiration of whatever phtyos and instrument drift
## create a mean blank slope per trial
## merge with the master(krill slopes) and "correct" all slopes against mean value (per trial)
# x is equal to the blank vials  

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

# Creating four separate means from the blank vials per trial
x70 <- subset(ksSlopes70, ksSlopes70$MOATS == "blank")

x70trial1 <- subset(x70, x70$TrialID == "Trial01")
x70trial2 <- subset(x70, x70$TrialID == "Trial02")
x70trial3 <- subset(x70, x70$TrialID == "Trial03")
x70trial4 <- subset(x70, x70$TrialID == "Trial04")

blank70meanslope1 <- mean(x70trial1$slope)
blank70meanslope2 <- mean(x70trial2$slope)
blank70meanslope3 <- mean(x70trial3$slope)
blank70meanslope4 <- mean(x70trial4$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

#Creating new corrected variables for slopes adjusted for blank vials and size of animal
ksSlopes70$CorrSlope <- ""
ksSlopes70$CorrSlope <- as.numeric(ksSlopes70$CorrSlope)
ksSlopes70$slope <- as.numeric(ksSlopes70$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Conditional Statement directing certain means to their respective trials
# take absolute values not to add a negative nubmer

ksSlopes.70 <- ksSlopes70 %>% mutate(CorrSlope=case_when(
    (ksSlopes70$MOATS == "blank" ~ ksSlopes70$slope),
    (ksSlopes70$TrialID == "Trial01" ~ ksSlopes70$slope-((blank70meanslope1))),
    (ksSlopes70$TrialID == "Trial02" ~ ksSlopes70$slope-((blank70meanslope2))),
    (ksSlopes70$TrialID == "Trial03" ~ ksSlopes70$slope-((blank70meanslope3))),
    (ksSlopes70$TrialID == "Trial04" ~ ksSlopes70$slope-((blank70meanslope4))),
    TRUE ~ as.numeric(0)
))


ksSlopes70 <- ksSlopes.70

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Correcting for the size of the animal 
ksSlopes70$WetWeight <- as.numeric(ksSlopes70$WetWeight)
ksSlopes70$WetWeightSlope <- ksSlopes70$CorrSlope/ksSlopes70$WetWeight

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |


#create plots and perhaps convert to larger units

``` 




# 21.e Summary Statisitics on the Unfiltered Dataframe dSlopes
```{r 21.e Summary Statisitics on the Unfiltered Dataframe dSlopes}

# factor(dSlopes$TrialID)
# 
# dSlopes <- filter(dSlopes, Treatment != "AMB")  
# dSlopes<- droplevels(filter(dSlopes, Treatment != "AMB"))

ksSlopes70<- droplevels(filter(ksSlopes70, Treatment != "n/a"))

ksSlopes70.summary <- ksSlopes70 %>% group_by(Treatment) %>%
  dplyr::summarize(sd = sd(CorrSlope, na.rm = TRUE), 
            mean = mean(CorrSlope, na.rm = TRUE), 
            median = median(CorrSlope, na.rm = TRUE),
            IQR = IQR(CorrSlope, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  mutate(ci = se*1.96)
ksSlopes70.summary

kable(ksSlopes70.summary, digits = 4)

write.csv(ksSlopes70.summary, "2021.01.26_ksSlopes70_summary.csv")
```




# 21.f) Analysis, Respirometry - Correcting the Slope for Blanks - 1hr cutoff
```{r 21.f) Analysis, Respirometry - Correcting the Slope for Blanks  - 1hr cutoff}

#*********************************
## 21.f) Analysis, Respirometry - Correcting the Slope for Blanks  - 1hr cutoff
#*********************************

#blank corrected slope and blank-size corrected slope
## need to correct all slopes with the blanks' slope
## this is the background respiration of whatever phtyos and instrument drift
## create a mean blank slope per trial
## merge with the master(krill slopes) and "correct" all slopes against mean value (per trial)
# x is equal to the blank vials  

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

# Creating four separate means from the blank vials per trial
x1hr <- subset(ksSlopes1hr, ksSlopes1hr$MOATS == "blank")

x1hrtrial1 <- subset(x1hr, x1hr$TrialID == "Trial01")
x1hrtrial2 <- subset(x1hr, x1hr$TrialID == "Trial02")
x1hrtrial3 <- subset(x1hr, x1hr$TrialID == "Trial03")
x1hrtrial4 <- subset(x1hr, x1hr$TrialID == "Trial04")

blank1hrmeanslope1 <- mean(x1hrtrial1$slope)
blank1hrmeanslope2 <- mean(x1hrtrial2$slope)
blank1hrmeanslope3 <- mean(x1hrtrial3$slope)
blank1hrmeanslope4 <- mean(x1hrtrial4$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |

#Creating new corrected variables for slopes adjusted for blank vials and size of animal
ksSlopes1hr$CorrSlope <- ""
ksSlopes1hr$CorrSlope <- as.numeric(ksSlopes1hr$CorrSlope)
ksSlopes1hr$slope <- as.numeric(ksSlopes1hr$slope)

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Conditional Statement directing certain means to their respective trials
# take absolute values not to add a negative nubmer

ksSlopes.1hr <- ksSlopes1hr %>% mutate(CorrSlope=case_when(
    (ksSlopes1hr$MOATS == "blank" ~ ksSlopes1hr$slope),
    (ksSlopes1hr$TrialID == "Trial01" ~ ksSlopes1hr$slope-((blank1hrmeanslope1))),
    (ksSlopes1hr$TrialID == "Trial02" ~ ksSlopes1hr$slope-((blank1hrmeanslope2))),
    (ksSlopes1hr$TrialID == "Trial03" ~ ksSlopes1hr$slope-((blank1hrmeanslope3))),
    (ksSlopes1hr$TrialID == "Trial04" ~ ksSlopes1hr$slope-((blank1hrmeanslope4))),
    TRUE ~ as.numeric(0)
))


ksSlopes1hr <- ksSlopes.1hr

# #|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
# Correcting for the size of the animal 
ksSlopes1hr$WetWeight <- as.numeric(ksSlopes1hr$WetWeight)
ksSlopes1hr$WetWeightSlope <- ksSlopes1hr$CorrSlope/ksSlopes1hr$WetWeight

#|- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |


#create plots and perhaps convert to larger units

``` 


# Executive Summary


# 21.g Summary Statisitics on the Unfiltered Dataframe dSlopes
```{r 21.g Summary Statisitics on the Unfiltered Dataframe dSlopes}

# factor(dSlopes$TrialID)
# 
# dSlopes <- filter(dSlopes, Treatment != "AMB")  
# dSlopes<- droplevels(filter(dSlopes, Treatment != "AMB"))
ksSlopes1hr<- droplevels(filter(ksSlopes1hr, Treatment != "n/a"))

ksSlopes1hr.summary <- ksSlopes1hr %>% group_by(Treatment) %>%
  dplyr::summarize(sd = sd(CorrSlope, na.rm = TRUE), 
            mean = mean(CorrSlope, na.rm = TRUE), 
            median = median(CorrSlope, na.rm = TRUE),
            IQR = IQR(CorrSlope, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  mutate(ci = se*1.96)
ksSlopes1hr.summary

kable(ksSlopes1hr.summary, digits = 4)

write.csv(ksSlopes1hr.summary, "2026.01.26_ksSlopes1hr_summary.csv")
```


# 22.) 80% Slope for Corrected Slopes
```{r}
plot80 <- ggplot(ksSlopes80, aes(Treatment, CorrSlope)) +
            geom_jitter(color = "grey") +
            geom_jitter(data = ksSlopes80, aes(Treatment, CorrSlope)) +
            # geom_jitter(data = krillslopes80.filtered, aes(Treatment, slope)) +
            # geom_jitter(data = krillslopes70.filtered, aes(Treatment, slope)) +
            # geom_jitter(data = kSlopes.filtered, aes(Treatment, slope)) +
            # geom_jitter(aes(colour = Treatment)) +
            geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
            geom_point(data = ksSlopes80.summary, aes(x=Treatment, y=mean), size=5, color = "purple") + 
            geom_errorbar(data = ksSlopes80.summary, 
                          aes(x=Treatment, y=mean, ymin = mean-sd, ymax = mean+sd), 
                          color = "blue") +
            geom_errorbar(data = ksSlopes80.summary,
                          aes(x=Treatment, y=mean, ymin = mean-ci, ymax = mean+ci),
                          colour = "red") +
            # facet_wrap(~TrialID) +
            ggtitle("ksSlopes80, (80% oxygen) Corrected Slope") +
            theme_bw() 


plot80
```

The purple dots represent the mean- all trials included
Confidence Intervals set to 95
Green boxplots show from the 25th percentil to the 75th percentile
error bars +/- SD shown in blue
error bars(CI) +/- our confidence intervals- shown in red




# 23.) 70% Slope for Corrected Slopes
```{r}
plot70 <- ggplot(ksSlopes70, aes(Treatment, CorrSlope)) +
            geom_jitter(color = "grey") +
            geom_jitter(data = ksSlopes70, aes(Treatment, CorrSlope)) +
            # geom_jitter(data = krillslopes80.filtered, aes(Treatment, slope)) +
            # geom_jitter(data = krillslopes70.filtered, aes(Treatment, slope)) +
            # geom_jitter(data = kSlopes.filtered, aes(Treatment, slope)) +
            # geom_jitter(aes(colour = Treatment)) +
            geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
            geom_point(data = ksSlopes70.summary, aes(x=Treatment, y=mean), size=5, color = "purple") + 
            geom_errorbar(data = ksSlopes70.summary, 
                          aes(x=Treatment, y=mean, ymin = mean-sd, ymax = mean+sd), 
                          color = "blue") +
            geom_errorbar(data = ksSlopes70.summary,
                          aes(x=Treatment, y=mean, ymin = mean-ci, ymax = mean+ci),
                          colour = "red") +
            # facet_wrap(~TrialID) +
            ggtitle("ksSlopes70, (70% oxygen) Corrected Slope") +
            theme_bw() 

plot70

```

The purple dots represent the mean- all trials included
Confidence Intervals set to 95
Green boxplots show from the 25th percentil to the 75th percentile
error bars +/- SD shown in blue
error bars(CI) +/- our confidence intervals- shown in red




# 24.) 1hr cutoff Slope for Corrected Slopes
```{r}

Onehrplot <- ggplot(ksSlopes1hr, aes(Treatment, CorrSlope)) +
            geom_jitter(color = "grey") +
            geom_jitter(data = ksSlopes1hr, aes(Treatment, CorrSlope)) +
            # geom_jitter(data = krillslopes80.filtered, aes(Treatment, slope)) +
            # geom_jitter(data = krillslopes70.filtered, aes(Treatment, slope)) +
            # geom_jitter(data = kSlopes.filtered, aes(Treatment, slope)) +
            # geom_jitter(aes(colour = Treatment)) +
            geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
            geom_point(data = ksSlopes1hr.summary, aes(x=Treatment, y=mean), size=5, color = "purple") + 
            geom_errorbar(data = ksSlopes1hr.summary, 
                          aes(x=Treatment, y=mean, ymin = mean-sd, ymax = mean+sd), 
                          color = "blue") +
            geom_errorbar(data = ksSlopes1hr.summary,
                          aes(x=Treatment, y=mean, ymin = mean-ci, ymax = mean+ci),
                          colour = "red") +
            # facet_wrap(~TrialID) +
            ggtitle("ksSlopes1hr, (1hr cutoff) Corrected Slope") +
            theme_bw() 

Onehrplot 

```

The purple dots represent the mean- all trials included
Confidence Intervals set to 95
Green boxplots show from the 25th percentil to the 75th percentile
error bars +/- SD shown in blue
error bars(CI) +/- our confidence intervals- shown in red



# 25.) Descriptive Statisitics 
```{r 25.) Descriptive Statisitics}
library(tidyr)
#Remove NAs
#krill <- na.omit(krill)
#Calculate mean and standard deviation for each treatment per each dataset
# blanks are to be removed from treatments

dSlopes<- droplevels(filter(dSlopes, Treatment != "n/a"))
ksSlopes80<- droplevels(filter(ksSlopes80, Treatment != "n/a"))
ksSlopes70<- droplevels(filter(ksSlopes70, Treatment != "n/a"))
ksSlopes1hr<- droplevels(filter(ksSlopes1hr, Treatment != "n/a"))


dSlopes_Avg <- tapply(dSlopes$CorrSlope, (dSlopes$Treatment), mean)
dSlopes_Med <- tapply(dSlopes$CorrSlope, (dSlopes$Treatment), median)
dSlopes_Std <- tapply(dSlopes$CorrSlope, (dSlopes$Treatment), sd)

ksSlopes80_Avg <- tapply(ksSlopes80$CorrSlope, (ksSlopes80$Treatment), mean)
ksSlopes80_Med <- tapply(ksSlopes80$CorrSlope, (ksSlopes80$Treatment), median)
ksSlopes80_Std <- tapply(ksSlopes80$CorrSlope, (ksSlopes80$Treatment), sd)

ksSlopes70_Avg <- tapply(ksSlopes70$CorrSlope, (ksSlopes70$Treatment), mean)
ksSlopes70_Med <- tapply(ksSlopes70$CorrSlope, (ksSlopes70$Treatment), median)
ksSlopes70_Std <- tapply(ksSlopes70$CorrSlope, (ksSlopes70$Treatment), sd)

ksSlopes1hr_Avg <- tapply(ksSlopes1hr$CorrSlope, (ksSlopes1hr$Treatment), mean)
ksSlopes1hr_Med <- tapply(ksSlopes1hr$CorrSlope, (ksSlopes1hr$Treatment), median)
ksSlopes1hr_Std <- tapply(ksSlopes1hr$CorrSlope, (ksSlopes1hr$Treatment), sd)


#Put it all together
Slope_Stats <- cbind(dSlopes_Avg, dSlopes_Med, dSlopes_Std,
                     ksSlopes80_Avg, ksSlopes80_Med, ksSlopes80_Std,
                     ksSlopes70_Avg, ksSlopes70_Med, ksSlopes70_Std,
                     ksSlopes1hr_Avg, ksSlopes1hr_Med, ksSlopes1hr_Std)

colnames(Slope_Stats) [1:12] <-c("Avg All Points Corrected Slopes", "Med All Points Corrected Slopes", "All Points Corrected Slopes SD", "Avg 80% DO Corrected Slopes", "Med 80% DO Corrected Slopes", "80% DO Corrected Slopes SD", "Avg 70% DO Corrected Slopes", "Med 70% DO Corrected Slopes", "70% DO Corrected Slopes SD", "Avg 1hr Corrected Slopes", "Med 1hr Corrected Slopes", "1hr Corrected Slopes SD")


write.csv(Slope_Stats, "2020.01.26_Slope_Stats.csv")

kable(Slope_Stats)

```




# 26.) Fitting my Linear Mixed-Effects Models to my Dataframes 
```{r Repeated measures analysis}
#Using a mixed model to find significant differences bertween MOATs
#library(nlme)
library(lme4)
library(lmerTest)

# Corrected Slopes , Treatment taking into account MOATS


ksSlopes.80<- droplevels(filter(ksSlopes.80, Treatment != "n/a"))
ksSlopes.70<- droplevels(filter(ksSlopes.70, Treatment != "n/a"))
ksSlopes.1hr<- droplevels(filter(ksSlopes.1hr, Treatment != "n/a"))
dSlopes<- droplevels(filter(dSlopes, Treatment != "n/a"))


ksSlopes.1hr_howmanyanimalsin_CHG <- subset(ksSlopes.1hr, Treatment == "CHG")
ks1hrCHGno <- unique(ksSlopes.1hr_howmanyanimalsin_CHG$KrillID)
# 16 animals in All Change across 4 trials

ksSlopes.1hr_howmanyanimalsin_CUR <- subset(ksSlopes.1hr, Treatment == "CUR")
ks1hrCURno <- unique(ksSlopes.1hr_howmanyanimalsin_CUR$KrillID)
# 19 animals from Current Treatment across 4 trials

ksSlopes.1hr_howmanyanimalsin_TMP <- subset(ksSlopes.1hr, Treatment == "TMP")
ks1hrTMPno <- unique(ksSlopes.1hr_howmanyanimalsin_TMP$KrillID)
# 16 animals in high Temperature Treatment across 4 trials


16+19+16
# [1] 51

```


# 26.a) 1hr Dataframe - LMER
```{r, 26.a) 1hr Dataframe - LMER}
lmer.ksSlopes.1hr <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.1hr)
summary(lmer.ksSlopes.1hr)
# All Change Against Current 
# All Change Against High Temperature
```

"1hr Dataset" - No Treatment Effect Found

Random Effects Model variance accounting for a possible MOATs effect remains significantly small.
No treatment effect observed. 
Neither correlation or T values between "All Change(CHG)" to "Current(CUR)" and "High Temperature(TMP)" 
This model doesn't consider High Temperature directly against Current
Model re-ogranized/re-leveled below


#### 26.b) 1hr Dataframe - LMER releved Current 1st
```{r 26.b) 1hr Dataframe - LMER}

levels(ksSlopes.1hr$Treatment)
# lmer.ksSlopes.1hr 
ksSlopes.1hr$Treatment <- fct_relevel(ksSlopes.1hr$Treatment, "CUR")
lmer.ksSlopes.1hr <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.1hr)
summary(lmer.ksSlopes.1hr)

```

The Current Conditions to Hight Temperature comparison did not display a treatment effect. 

Possible reasons for such small amount of variance include only 51 animals in trial.
16 animals from the "All Change" treatment were in included across four trials.
19 animals from the "Current" treatment were in included across four trials.
16 animals from the "High Temperarure" treatment were in included across four trials.
(totals 51 animals)

so signal over the noise- why?

1hr may not have allowed enough observations to show a disernable difference across treatments.
However, Krill could just be proving to be a robust organism, able to withstand a cross stress environment. 
It's more likely that sample size was small.



# 26.c) 80% Threshold Dataframe - LMER
```{r, 26.c) 1hr Dataframe - LMER}
lmer.ksSlopes.80 <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.80)
summary(lmer.ksSlopes.80)
# All Change Against Current 
# All Change Against High Temperature
```

The 80% (DO) Threshold t values are slightly smaller. 
The variance around a MOATs effect remains significantly small.
No treatment effect observed.
Model re-organized/re-leveled below to compare "Current" against "High Temperature" directly



#### 26.d) 80% Threshold - LMER releved Current 1st
```{r 26.d) 80% Dataframe - LMER}

levels(ksSlopes.80$Treatment)
# lmer.ksSlopes.1hr 
ksSlopes.80$Treatment <- fct_relevel(ksSlopes.80$Treatment, "CUR")
lmer.ksSlopes.80 <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.80)
summary(lmer.ksSlopes.80)

```
When comparing Current against "High Temperature" and "All Change" the T values remain small but the TMP to CUR is somewhat larger. 

Still, no discernible treatment effect, no discernible MOATS effect. 



# 26.e) 70% Threshold Dataframe - LMER
```{r, 26.e) 70% Dataframe - LMER}
lmer.ksSlopes.70 <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.70)
summary(lmer.ksSlopes.70)
# All Change Against Current 
# All Change Against High Temperature
```


The variance around a MOATs effect remains significantly small in this 70% Threshold dataset.
No treatment effect observed.
Model re-organized/re-leveled below to compare "Current" against "High Temperature" directly


#### 26.f) 70% Threshold - LMER releved Current 1st
```{r 26.f) 70% Dataframe - LMER}

levels(ksSlopes.70$Treatment)
# lmer.ksSlopes.1hr 
ksSlopes.70$Treatment <- fct_relevel(ksSlopes.70$Treatment, "CUR")
lmer.ksSlopes.70 <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.70)
summary(lmer.ksSlopes.70)

```

No discernible treatment effect, no discernible MOATS effect. 
None of the "threshold confined" datasets displayed a MOATs or Treatment Effect.


Below shows the comparison is slopes values when all data points were considered. 


# 26.g) All Points "dSlopes" Dataframe - LMER
```{r, 26.g) All Points Dataframe - LMER}
lmer.dSlopes<- lmer(CorrSlope ~ Treatment + (1|MOATS), data = dSlopes)
summary(lmer.dSlopes)
# All Change Against Current 
# All Change Against High Temperature
```


The variance around a MOATs effect remains so significantly small.
No MOATs effect
No treatment effect observed.
Model re-organized/re-leveled below to compare "Current" against "High Temperature" directly


#### 26.f) All Points - LMER releved Current 1st
```{r 26.f) All Points - LMER}

levels(dSlopes$Treatment)

dSlopes$Treatment <- fct_relevel(dSlopes$Treatment, "CUR")
lmer.dSlopes <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = dSlopes)
summary(lmer.dSlopes)

```



```{r Models Commented Out & next step thoughts}
# 
# # Just a chunk of the models held back case I need them.  
# 
# lmer.ksSlopes.80 <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.80)
# summary(lmer.ksSlopes.80)
# 
# lmer.ksSlopes.70 <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = ksSlopes.70)
# summary(lmer.ksSlopes.70)
# 
# lmer.dSlopes <- lmer(CorrSlope ~ Treatment + (1|MOATS), data = dSlopes)
# summary(lmer.dSlopes)
# 
# 
# 
# # what about different rounds on different days?
```




```{r}

Onehrplot
```


```{r}
plot70
```



```{r}
plot80
```


```{r}
dSlopesplot
```




*Slope Statistics*
```{r}
kable(Slope_Stats)
```


*Krill Slopes 1hr Summary Table*
```{r}
kable(ksSlopes1hr.summary, digits = 4)
```


*Krill Slopes (70min cutoff) Summary Table*
```{r}
kable(ksSlopes70.summary, digits = 8)
```


*Krill Slopes (80min cutoff) Summary Table*
```{r}
kable(ksSlopes80.summary, digits = 8)
```


*Krill Slopes (all points) Summary Table*
```{r}
kable(dSlopes.summary, digits = 8)
```


*Krill Slopes (1hr cutoff) Mixed Effects Model*
```{r}
summary(lmer.ksSlopes.1hr)
```


*Krill Slopes (80min cutoff) Mixed Effects Model*
```{r}
summary(lmer.ksSlopes.80)
```


*Krill Slopes (70min cutoff) Mixed Effects Model*
```{r}
summary(lmer.ksSlopes.70)
```


*Krill Slopes (all points) Mixed Effects Model*
```{r}
summary(lmer.dSlopes)
```


# 27.) Writing CSVs for follow on work
```{r}

```



# 28.) Linear Models
``` {r }
> fit.1hr <- lm(CorrSlope ~ Treatment, data=ksSlopes.1hr)
> summary(fit)
```


# 29. Writing Documents 
```{r 29.a All Points}
write.csv(dSlopes, file = "2021.02.09_Slopes_allpts.csv", row.names = FALSE)
```



# 29.b Writing Documents 
```{r 29.b  80% threshold Points}
write.csv(ksSlopes.80, file = "2021.02.09_ksSlopes.80.csv", row.names = FALSE)
```




# 29.c Writing Documents 
```{r 29.c  70% threshold Points}
write.csv(ksSlopes.70, file = "2021.02.09_ksSlopes.70.csv", row.names = FALSE)
```



# 29.d Writing Documents 
```{r 29.d  1hr threshold Points}
write.csv(ksSlopes.1hr, file = "2021.02.09_ksSlopes.1hr.csv", row.names = FALSE)
```















```{r}
#**************E*N*D*************# 
#*********************************
## END OF SCRIPT | END OF DOCUMENT 
#*********************************
```


## END OF SCRIPT | END OF DOCUMENT












